shadow$provide.module$node_modules$web3_providers_ws$lib$index=function(global,require,module,exports){var EventEmitter=require("module$node_modules$eventemitter3$index"),helpers=require("module$node_modules$web3_providers_ws$lib$helpers"),errors=require("module$node_modules$web3_core_helpers$lib$index").errors,Ws=require("module$node_modules$websocket$lib$browser").w3cwebsocket;global=function(url,options){EventEmitter.call(this);options=options||{};this.url=url;this._customTimeout=options.timeout||
15E3;this.headers=options.headers||{};this.protocol=options.protocol||void 0;this.reconnectOptions=Object.assign({auto:!1,delay:5E3,maxAttempts:!1,onTimeout:!1},options.reconnect);this.clientConfig=options.clientConfig||void 0;this.requestOptions=options.requestOptions||void 0;this.DATA="data";this.CLOSE="close";this.ERROR="error";this.CONNECT="connect";this.RECONNECT="reconnect";this.connection=null;this.requestQueue=new Map;this.responseQueue=new Map;this.reconnectAttempts=0;this.reconnecting=!1;
url=helpers.parseURL(url);url.username&&url.password&&(this.headers.authorization="Basic "+helpers.btoa(url.username+":"+url.password));url.auth&&(this.headers.authorization="Basic "+helpers.btoa(url.auth));Object.defineProperty(this,"connected",{get:function(){return this.connection&&this.connection.readyState===this.connection.OPEN},enumerable:!0});this.connect()};global.prototype=Object.create(EventEmitter.prototype);global.prototype.constructor=global;global.prototype.connect=function(){this.connection=
new Ws(this.url,this.protocol,void 0,this.headers,this.requestOptions,this.clientConfig);this._addSocketListeners()};global.prototype._onMessage=function(e){var _this=this;this._parseResponse("string"===typeof e.data?e.data:"").forEach(function(result){if(result.method&&-1!==result.method.indexOf("_subscription"))_this.emit(_this.DATA,result);else{var id=result.id;Array.isArray(result)&&(id=result[0].id);_this.responseQueue.has(id)&&(void 0!==_this.responseQueue.get(id).callback&&_this.responseQueue.get(id).callback(!1,
result),_this.responseQueue.delete(id))}})};global.prototype._onConnect=function(){this.emit(this.CONNECT);this.reconnectAttempts=0;this.reconnecting=!1;if(0<this.requestQueue.size){var _this=this;this.requestQueue.forEach(function(request,key){_this.send(request.payload,request.callback);_this.requestQueue.delete(key)})}};global.prototype._onClose=function(event){var _this=this;!this.reconnectOptions.auto||[1E3,1001].includes(event.code)&&!1!==event.wasClean?(this.emit(this.CLOSE,event),0<this.requestQueue.size&&
this.requestQueue.forEach(function(request,key){request.callback(errors.ConnectionNotOpenError(event));_this.requestQueue.delete(key)}),0<this.responseQueue.size&&this.responseQueue.forEach(function(request,key){request.callback(errors.InvalidConnection("on WS",event));_this.responseQueue.delete(key)}),this._removeSocketListeners(),this.removeAllListeners()):this.reconnect()};global.prototype._addSocketListeners=function(){this.connection.addEventListener("message",this._onMessage.bind(this));this.connection.addEventListener("open",
this._onConnect.bind(this));this.connection.addEventListener("close",this._onClose.bind(this))};global.prototype._removeSocketListeners=function(){this.connection.removeEventListener("message",this._onMessage);this.connection.removeEventListener("open",this._onConnect);this.connection.removeEventListener("close",this._onClose)};global.prototype._parseResponse=function(data$jscomp$0){var _this=this,returnValues=[];data$jscomp$0.replace(/\}[\n\r]?\{/g,"}|--|{").replace(/\}\][\n\r]?\[\{/g,"}]|--|[{").replace(/\}[\n\r]?\[\{/g,
"}|--|[{").replace(/\}\][\n\r]?\{/g,"}]|--|{").split("|--|").forEach(function(data){_this.lastChunk&&(data=_this.lastChunk+data);var result=null;try{result=JSON.parse(data)}catch(e){_this.lastChunk=data;clearTimeout(_this.lastChunkTimeout);_this.lastChunkTimeout=setTimeout(function(){_this.reconnectOptions.auto&&_this.reconnectOptions.onTimeout?_this.reconnect():(_this.emit(_this.ERROR,errors.ConnectionTimeout(_this._customTimeout)),0<_this.requestQueue.size&&_this.requestQueue.forEach(function(request,
key){request.callback(errors.ConnectionTimeout(_this._customTimeout));_this.requestQueue.delete(key)}))},_this._customTimeout);return}clearTimeout(_this.lastChunkTimeout);_this.lastChunk=null;result&&returnValues.push(result)});return returnValues};global.prototype.send=function(payload,callback){var id=payload.id;callback={payload,callback};Array.isArray(payload)&&(id=payload[0].id);if(this.connection.readyState===this.connection.CONNECTING||this.reconnecting)this.requestQueue.set(id,callback);else if(this.connection.readyState!==
this.connection.OPEN)this.requestQueue.delete(id),this.emit(this.ERROR,errors.ConnectionNotOpenError()),callback.callback(errors.ConnectionNotOpenError());else{this.responseQueue.set(id,callback);this.requestQueue.delete(id);try{this.connection.send(JSON.stringify(callback.payload))}catch(error){callback.callback(error),this.responseQueue.delete(id)}}};global.prototype.reset=function(){this.responseQueue.clear();this.requestQueue.clear();this.removeAllListeners();this._removeSocketListeners();this._addSocketListeners()};
global.prototype.disconnect=function(code,reason){this._removeSocketListeners();this.connection.close(code||1E3,reason)};global.prototype.supportsSubscriptions=function(){return!0};global.prototype.reconnect=function(){var _this=this;this.reconnecting=!0;0<this.responseQueue.size&&this.responseQueue.forEach(function(request,key){request.callback(errors.PendingRequestsOnReconnectingError());_this.responseQueue.delete(key)});!this.reconnectOptions.maxAttempts||this.reconnectAttempts<this.reconnectOptions.maxAttempts?
setTimeout(function(){_this.reconnectAttempts++;_this._removeSocketListeners();_this.emit(_this.RECONNECT,_this.reconnectAttempts);_this.connect()},this.reconnectOptions.delay):(this.emit(this.ERROR,errors.MaxAttemptsReachedOnReconnectingError()),this.reconnecting=!1,0<this.requestQueue.size&&this.requestQueue.forEach(function(request,key){request.callback(errors.MaxAttemptsReachedOnReconnectingError());_this.requestQueue.delete(key)}))};module.exports=global}
//# sourceMappingURL=module$node_modules$web3_providers_ws$lib$index.js.map
